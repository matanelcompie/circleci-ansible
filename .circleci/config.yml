version: 2.1
jobs:
  deploy:
    machine:
      enabled: true
    working_directory: ~/app
    environment:
      VAR: "<< pipeline.parameters.var_test >>"
    steps:
      - checkout
      - run: pwd; ls; echo -e "$SSH_HOST\n${SSH_HOST}\n\n$VAR\n${VAR}" # delete (for test)
      #- run: echo $SSH_PRIVATE_HOST >> ./ansible/inventory; cat ./ansible/inventory # insert private host ip to ansible inventory
      - run: ssh $SSH_USER@$SSH_HOST "hostname" # delete (for test)
      - run: scp -r ./ansible "$SSH_USER@$SSH_HOST:/home/$SSH_USER" # copy ansible directory to Bastion EC2 host with new inventore (from checkout)
      - run: ssh $SSH_USER@$SSH_HOST "cd ansible; ansible dev -m file -a 'path=/home/ubuntu/${VAR}.txt state=touch'" # run playbook
      - run:
          name: Run multiple ansible ad-hoc commands
          command: |
            ssh $SSH_USER@$SSH_HOST "cd ansible; for i in <<parameters.envs>>; do ansible dev -m file -a 'path=/home/ubuntu/$i.txt state=touch' done"
parameters:
  envs:
    description: project environments
    default: ${envs}
    type: string

workflows:
  version: 2.1
  build-and-deploy:
    jobs:
      - deploy:
          filters:
            branches:
              only: main # only deploy on the main branch
# ssh $SSH_USER@$SSH_HOST "ansible dev -m command -a 'hostname'"
# - run: ssh $SSH_USER@$SSH_HOST "ansible-playbook /home/ubuntu/ansible/playbook.yaml"
# - run: ssh $SSH_USER@$SSH_HOST "ansible dev -i /home/ubuntu/ansible/inventory -m file -a 'path=/home/ubuntu/ubuntu_test.txt state=touch'"
#- run: ssh $SSH_USER@$SSH_HOST "ansible all -i inventory -m ping"
